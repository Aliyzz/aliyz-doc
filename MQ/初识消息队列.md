# 初识消息队列

----

## What is it ？

> 简称 MQ(Message Queue)，数据结构是 FIFO队列，独立的（分布式）消息中间件服务；涉及 生产者、消费者 两个角色。

## What's the usage?

#### 异步

> 提高 ***主业务流程*** 响应速度，用户体验更好；<br>
> 分担 主业务流程 处理压力，性能得到提升；<br>
> 综合提升整个系统的服务能力，支持更高的并发。

#### 削峰/限流、填谷

> 有效解决请求量在时间上的分布不均衡，保护了核心业务系统，也提高了系统接收请求的能力；
> 
> 削峰/限流 <br>
>> 系统将过载的请求放入消息队列，后续根据业务系统处理能力慢慢消费请求。<br>
>
> 填谷 <br>
>> 在请求低峰时期消费高峰时期的请求，时间上均衡服务器压力。

#### 解耦
 
`各系统由于创建时间、业务需求等因素，导致接口的标准、口径不统一`

> 系统间通信由直接连接转变为间接访问；<br>
> 系统间通信方式统一化、单一化、标准化，消息驱动业务；<br>
> 系统变更影响传播减小，升级、部署灵活、方便。



## What's the trouble

#### 系统复杂性

- 重复消费

> 描述：由于在网络延迟等因素下，不可避免地需要消息重复发送（由开发来保证），那样消费端收到两条一样的消息并消费
> 
> 解决：业务逻辑幂等。简单逻辑用幂等函数（如：Redis的set操作），复杂业务用全局流水号（如：订单号+业务场景）等。

- 消息丢失

> 问题来源
> 
>> ***来源1***：生产者生产的消息在向MQ传输的过程中丢失；<br>
>> ***来源2***：MQ 收到消息后先放到缓存里，还没来得及被消费，挂了；<br>
>> ***来源3***：消费者拿到消息后没来得及处理，挂了。
>
> 解决方案
> 
>> 针对不同的 MQ，对应措施都不一样，这里给个参考链接：
>> `https://www.jianshu.com/p/4491cba335d1`

- 顺序消费

> RocketMQ 的topic内的队列机制，可以保证存储满足FIFO，生产者可以根据 `HASH取模法` 将同一业务的消息发送到同一个队列，剩下的只需要消费者顺序消费即可。
> 
> 顺序消费需要保证消费者单线程消费，如果消费者多线程消费怎么办？引入事物消费👇。

- 事物消费

> 消息 生产-消费 的业务流程启用分布式事物（👇）机制。


#### 数据一致性

- 分布式事务

> 这里详细介绍：半消息/最终一致性（RocketMQ）
> 
>> ***第一阶段***：生产者发送消息给 RocketMQ；RocketMQ 将消息状态设置为 `prepared` 并持久化；然后 RocketMQ 回调生产者，这个过程中会返回 **消息地址**；
>> 
>> ***第二阶段***：生产者执行本地事物；
>> 
>> ***第三阶段***：生产者将事物执行结果（成功 或 失败）发送确认消息（携带第一阶段返回的消息地址）给 RocketMQ；RocketMQ 判断，成功--修改消息状态为 `commited`/失败--删除消息；
>> 
>> 最后 RocketMQ 发送状态为 `commited` 的消息给消费者。
>
> 其他实现方式还有下面的方案（先不详细介绍）
> 
>> - 2pc（两段式提交）
>> - 3pc（三段式提交）
>> - TCC（Try、Confirm、Cancel）
>> - 最大努力通知
>> - XA
>> - 本地消息表（ebay研发出的）
>
> ***注意：分布式事务启用会影响 系统性能，降低吞吐率***

#### 可用性

> 消息中间件架构：HA、Cluster。

## Popular Technology

> Kafka、ActiveMQ、RabbitMQ、RocketMQ、NSQ

- 对比（20200630 总结）

| 特性 | ActiveMQ | RabbitMQ | RocketMQ | Kafka |
| ---- | ---- | ---- | ---- | ---- |
| ***单机吞吐量*** | 万级 | 万级 | 10万级 | 10万级，高吞吐，一般配合大数据系统进行实时计算、日志采集等 |
| ***TOPIC数量对吞吐量的影响*** |  |  | TOPIC可达几百/几千，吞吐量会有小幅度下降 ***优势*** | TOPIC从几十到几百的时候，吞吐量大幅下降，同等机器下，尽量保证TOPIC不要太多，否则多机部署解决 |
| ***时效性*** | 毫秒级 | 微秒级，***延迟最低*** | 毫秒级 | 毫秒级，延迟在毫秒以内 |
| ***可用性*** | 高，主从架构 | 高，主从架构 | 非常高，分布式架构 | 非常高，分布式，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用 |
| ***消息可靠性*** | 低概率数据丢失 | 基本不丢 | 经过参数优化配置，可0丢失 | 经过参数优化配置，可0丢失 |
| ***功能支持*** | MQ领域功能**及其**完备 | 基于erlang开发，并发强、性能好、延迟低 | MQ领域功能较为完善，分布式，扩展性好 | 功能较为简单 |
| ***社区活跃度*** | 低 | 中 | 高 | 高 |
