# Redis 缓存问题

-----

## 引言

```
使用缓存可以给系统带来一定的复杂性和额外的维护成本，那么为什么要用缓存服务器呢？
```

>1、提高性能：缓存查询速度比数据库查询速度快（内存vs硬盘）<br>
 2、提高并发能力：缓存分担部分请求，支持更高的并发


## 雪崩效应

- 问题描述

	>缓存中的数据在几乎同一时间内***大面积失效***，或者***缓存层出现错误***，所有的请求都会打到持久层数据库，数据库的调用量会暴增，致使数据库超载甚至挂掉。<br><br>
	 造成原因可能是因为大部分 key 设置了（几乎）相同的过期时间。
	
- 解决办法
	
	>1、缓存失效的情况<br>
	>>a.**随机过期时间**：在往Redis存数据的时候，把每个Key的失效时间都加个随机值就好，这样可以保证数据不会在同一时间大面积失效。<br>
	  b.热点数据永不过期，有需要变化的时候更新即可。<br>
	  c.**限流降级**：在缓存失效后，通过加锁或者队列来控制读数据库写缓存的线程数量。
	  
	>2、Redis服务宕机的情况<br>
	>>**Redis高可用**，搭建redis集群。
	
	>3、**数据预热**：在正式部署之前，我先把可能的数据先预先访问一遍，这样部分可能大量访问的数据就会加载到缓存中
	

## 缓存穿透 
- 问题描述

	>用户访问一个 key，缓存层没有命中，转而访问持久层数据库，数据库也没有，查询失败；当这样的请求很多时，致使数据库超载甚至挂掉。<br><br>
	这可能是黑客恶意攻击。
	
- 解决办法

	>**服务接口做好参数校验**，比如：数据库id<=0的直接拦截、分页参数单次查询数量巨大者拒绝等。<br>
	**布隆过滤器（Bloom Filter）**，它可以判断请求的 key 在缓存中 ***一定不存在*** 或 ***可能存在*** 。<br>
	**缓存空对象**，当缓存层不命中后，后端返回的空对象也将其缓存起来，同时会设置一个过期时间（相对较小），之后再访问这个 key 将会从缓存中获取，保护了后端数据源。<br>
	>>这种方法会存在两个问题：<br>
	1、空值被缓存，将会占用更多的内存空间；<br>
	2、过期时间设置，使得缓存层和存储层数据在一段时间内不一致，这对于需要保持一致性的业务会有影响。


## 缓存击穿

- 问题描述

	>一个热点 key 失效的瞬间，大量请求全部打到数据库，致使数据库超载甚至挂掉。*就像在一个完好无损的桶上凿开了一个洞。*
	
- 解决办法

	>处理根雪崩类似。
	
	
## ^_^三段分析法～～

- **事前**：Redis 高可用，主从+哨兵，Redis cluster，避免全盘崩溃。

- **事中**：本地 ehcache 缓存 + Hystrix 限流+降级，避免数据库被打死。

- **事后**：Redis 持久化 RDB+AOF，一旦重启，自动从磁盘上加载数据，快速恢复缓存数据。